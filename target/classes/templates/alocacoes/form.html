<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nova Aloca√ß√£o - Geosense</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .form-section {
        border-left: 4px solid #667eea;
        padding-left: 15px;
        margin-bottom: 20px;
      }
      .alert-custom {
        border-radius: 8px;
      }
      .btn-custom {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
      }
      .vaga-disponivel {
        color: #28a745;
        font-weight: bold;
      }
      .vaga-ocupada {
        color: #dc3545;
        font-weight: bold;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-4">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <!-- Cabe√ßalho -->
          <div class="card shadow">
            <div class="card-header">
              <h4 class="mb-0">üìç Alocar/Realocar Moto</h4>
              <small
                >Mova uma moto para uma nova vaga ou aloque moto sem vaga</small
              >
            </div>

            <div class="card-body">
              <!-- Mensagens de erro/sucesso -->
              <div th:if="${error}" class="alert alert-danger alert-custom">
                <i class="fas fa-exclamation-triangle"></i>
                <span th:text="${error}"></span>
              </div>

              <!-- Formul√°rio -->
              <form
                th:action="@{/alocacoes}"
                th:object="${alocacao}"
                method="post"
              >
                <!-- 1. Sele√ß√£o da Moto -->
                <div class="form-section">
                  <h6 class="text-primary">üèçÔ∏è Selecionar Moto</h6>
                  <div class="mb-3">
                    <label for="motoId" class="form-label"
                      >Moto <span class="text-danger">*</span></label
                    >
                    <select
                      class="form-select"
                      id="motoId"
                      th:field="*{motoId}"
                      required
                    >
                      <option value="">-- Selecione uma moto --</option>
                      <option
                        th:each="moto : ${motos}"
                        th:value="${moto.id}"
                        th:text="${moto.modelo + ' - ' + (moto.placa != null ? moto.placa : moto.chassi) + (moto.vaga != null ? ' (Atual: Vaga ' + moto.vaga.numero + ')' : ' (Sem vaga)')}"
                      ></option>
                    </select>
                    <div class="form-text">
                      Selecione qualquer moto para alocar/realocar em uma nova
                      vaga
                    </div>
                    <div
                      th:if="${#fields.hasErrors('motoId')}"
                      class="text-danger"
                      th:errors="*{motoId}"
                    ></div>
                  </div>
                </div>

                <!-- 2. Sele√ß√£o do P√°tio -->
                <div class="form-section">
                  <h6 class="text-primary">üè¢ Selecionar P√°tio</h6>
                  <div class="mb-3">
                    <label for="patioId" class="form-label"
                      >P√°tio <span class="text-danger">*</span></label
                    >
                    <select
                      class="form-select"
                      id="patioId"
                      th:field="*{patioId}"
                      onchange="carregarVagasDisponiveis()"
                      required
                    >
                      <option value="">-- Selecione um p√°tio --</option>
                      <option
                        th:each="patio : ${patios}"
                        th:value="${patio.id}"
                        th:text="${patio.nomeUnidade + ' - ' + patio.localizacao + ' (' + patio.vagasDisponiveis + ' vagas dispon√≠veis)'}"
                      ></option>
                    </select>
                    <div
                      th:if="${#fields.hasErrors('patioId')}"
                      class="text-danger"
                      th:errors="*{patioId}"
                    ></div>
                  </div>
                </div>

                <!-- 3. Sele√ß√£o da Vaga -->
                <div class="form-section">
                  <h6 class="text-primary">üÖøÔ∏è Selecionar Vaga</h6>
                  <div class="mb-3">
                    <label for="vagaId" class="form-label"
                      >Vaga <span class="text-danger">*</span></label
                    >
                    <select
                      class="form-select"
                      id="vagaId"
                      th:field="*{vagaId}"
                      required
                      disabled
                    >
                      <option value="">
                        -- Primeiro selecione um p√°tio --
                      </option>
                    </select>
                    <div class="form-text">
                      As vagas dispon√≠veis aparecer√£o ap√≥s selecionar o p√°tio
                    </div>
                    <div
                      th:if="${#fields.hasErrors('vagaId')}"
                      class="text-danger"
                      th:errors="*{vagaId}"
                    ></div>
                  </div>
                </div>

                <!-- 4. Mec√¢nico Respons√°vel (Opcional) -->
                <div class="form-section">
                  <h6 class="text-primary">üë®‚Äçüîß Mec√¢nico Respons√°vel</h6>
                  <div class="mb-3">
                    <label for="mecanicoId" class="form-label"
                      >Mec√¢nico (Opcional)</label
                    >
                    <select
                      class="form-select"
                      id="mecanicoId"
                      th:field="*{mecanicoId}"
                    >
                      <option value="">-- Nenhum mec√¢nico --</option>
                      <option
                        th:each="mecanico : ${mecanicos}"
                        th:value="${mecanico.id}"
                        th:text="${mecanico.nome}"
                      ></option>
                    </select>
                  </div>
                </div>

                <!-- 5. Observa√ß√µes -->
                <div class="form-section">
                  <h6 class="text-primary">üìù Observa√ß√µes</h6>
                  <div class="mb-4">
                    <label for="observacoes" class="form-label"
                      >Observa√ß√µes (Opcional)</label
                    >
                    <textarea
                      class="form-control"
                      id="observacoes"
                      th:field="*{observacoes}"
                      rows="3"
                      placeholder="Ex: Moto para revis√£o completa..."
                    ></textarea>
                  </div>
                </div>

                <!-- Bot√µes -->
                <div class="d-flex gap-2">
                  <button
                    type="submit"
                    class="btn btn-custom btn-primary text-white"
                  >
                    üìç Alocar/Realocar Moto
                  </button>
                  <a th:href="@{/alocacoes}" class="btn btn-outline-secondary">
                    ‚Ü©Ô∏è Cancelar
                  </a>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript para carregar vagas -->
    <script>
      function carregarVagasDisponiveis() {
        const patioId = document.getElementById("patioId").value;
        const vagaSelect = document.getElementById("vagaId");

        if (!patioId) {
          vagaSelect.innerHTML =
            '<option value="">-- Primeiro selecione um p√°tio --</option>';
          vagaSelect.disabled = true;
          return;
        }

        console.log("Carregando vagas para p√°tio:", patioId);

        // Resetar select
        vagaSelect.innerHTML =
          '<option value="">üîÑ Carregando vagas...</option>';
        vagaSelect.disabled = true;

        // Buscar vagas via AJAX
        fetch(`/patios/${patioId}/vagas-disponiveis`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Erro ao buscar vagas");
            }
            return response.json();
          })
          .then((vagas) => {
            console.log("Vagas recebidas:", vagas);

            vagaSelect.innerHTML = "";

            if (vagas.length === 0) {
              vagaSelect.innerHTML =
                '<option value="">‚ùå Nenhuma vaga dispon√≠vel</option>';
            } else {
              vagaSelect.innerHTML =
                '<option value="">-- Selecione uma vaga --</option>';

              vagas.forEach((vaga) => {
                const option = document.createElement("option");
                option.value = vaga.id;
                option.textContent = `üü¢ Vaga ${vaga.numero} (${vaga.tipo})`;
                vagaSelect.appendChild(option);
              });

              vagaSelect.disabled = false;
            }
          })
          .catch((error) => {
            console.error("Erro ao carregar vagas:", error);
            vagaSelect.innerHTML =
              '<option value="">‚ùå Erro ao carregar vagas</option>';
          });
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
