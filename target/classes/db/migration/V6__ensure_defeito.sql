-- V6: Ensure DEFEITO table and related FK/index (Oracle-safe)

-- Create DEFEITO if missing
DECLARE v_exists NUMBER; BEGIN
  SELECT COUNT(*) INTO v_exists FROM user_tables WHERE table_name = 'DEFEITO';
  IF v_exists = 0 THEN
    EXECUTE IMMEDIATE 'CREATE TABLE DEFEITO (
      ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      TIPOS_DEFEITOS VARCHAR2(40) NOT NULL,
      DESCRICAO VARCHAR2(255) NOT NULL,
      MOTO_ID NUMBER(19) NOT NULL
    )';
  END IF;
END;
/

-- Add FK if missing (only if both tables exist)
DECLARE n NUMBER; t1 NUMBER; t2 NUMBER; BEGIN
  SELECT COUNT(*) INTO t1 FROM user_tables WHERE table_name = 'DEFEITO';
  SELECT COUNT(*) INTO t2 FROM user_tables WHERE table_name = 'MOTO';
  IF t1 > 0 AND t2 > 0 THEN
    SELECT COUNT(*) INTO n FROM user_constraints WHERE constraint_name = 'FK_DEFEITO_MOTO';
    IF n = 0 THEN EXECUTE IMMEDIATE 'ALTER TABLE DEFEITO ADD CONSTRAINT FK_DEFEITO_MOTO FOREIGN KEY (MOTO_ID) REFERENCES MOTO (ID)'; END IF;
  END IF;
END;
/

-- Index for DEFEITO.MOTO_ID if missing
DECLARE n NUMBER; t NUMBER; BEGIN
  SELECT COUNT(*) INTO t FROM user_tables WHERE table_name = 'DEFEITO';
  IF t > 0 THEN
    SELECT COUNT(*) INTO n FROM user_indexes WHERE index_name = 'IDX_DEFEITO_MOTO';
    IF n = 0 THEN EXECUTE IMMEDIATE 'CREATE INDEX IDX_DEFEITO_MOTO ON DEFEITO (MOTO_ID)'; END IF;
  END IF;
END;
/

