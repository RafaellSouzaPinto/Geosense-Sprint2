-- V5: Ensure ALOCACAO_MOTO table, FKs and indexes exist (Oracle-safe)

DECLARE v_exists NUMBER; BEGIN
  SELECT COUNT(*) INTO v_exists FROM user_tables WHERE table_name = 'ALOCACAO_MOTO';
  IF v_exists = 0 THEN
    EXECUTE IMMEDIATE 'CREATE TABLE ALOCACAO_MOTO (
      ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      MOTO_ID NUMBER(19) NOT NULL,
      VAGA_ID NUMBER(19) NOT NULL,
      MECANICO_RESPONSAVEL_ID NUMBER(19),
      DATA_HORA_ALOCACAO TIMESTAMP
    )';
  END IF;
END;
/

-- FKs
DECLARE n NUMBER; t NUMBER; t2 NUMBER; BEGIN
  SELECT COUNT(*) INTO t FROM user_tables WHERE table_name = 'ALOCACAO_MOTO';
  SELECT COUNT(*) INTO t2 FROM user_tables WHERE table_name = 'MOTO';
  IF t > 0 AND t2 > 0 THEN
    SELECT COUNT(*) INTO n FROM user_constraints WHERE constraint_name = 'FK_ALOCACAO_MOTO';
    IF n = 0 THEN EXECUTE IMMEDIATE 'ALTER TABLE ALOCACAO_MOTO ADD CONSTRAINT FK_ALOCACAO_MOTO FOREIGN KEY (MOTO_ID) REFERENCES MOTO (ID)'; END IF;
  END IF;
END;
/

DECLARE n NUMBER; t NUMBER; t2 NUMBER; BEGIN
  SELECT COUNT(*) INTO t FROM user_tables WHERE table_name = 'ALOCACAO_MOTO';
  SELECT COUNT(*) INTO t2 FROM user_tables WHERE table_name = 'VAGA';
  IF t > 0 AND t2 > 0 THEN
    SELECT COUNT(*) INTO n FROM user_constraints WHERE constraint_name = 'FK_ALOCACAO_VAGA';
    IF n = 0 THEN EXECUTE IMMEDIATE 'ALTER TABLE ALOCACAO_MOTO ADD CONSTRAINT FK_ALOCACAO_VAGA FOREIGN KEY (VAGA_ID) REFERENCES VAGA (ID)'; END IF;
  END IF;
END;
/

DECLARE n NUMBER; t NUMBER; t2 NUMBER; BEGIN
  SELECT COUNT(*) INTO t FROM user_tables WHERE table_name = 'ALOCACAO_MOTO';
  SELECT COUNT(*) INTO t2 FROM user_tables WHERE table_name = 'USUARIO';
  IF t > 0 AND t2 > 0 THEN
    SELECT COUNT(*) INTO n FROM user_constraints WHERE constraint_name = 'FK_ALOCACAO_MECANICO';
    IF n = 0 THEN EXECUTE IMMEDIATE 'ALTER TABLE ALOCACAO_MOTO ADD CONSTRAINT FK_ALOCACAO_MECANICO FOREIGN KEY (MECANICO_RESPONSAVEL_ID) REFERENCES USUARIO (ID)'; END IF;
  END IF;
END;
/

-- Indexes (idempotent)
DECLARE n NUMBER; t NUMBER; BEGIN
  SELECT COUNT(*) INTO t FROM user_tables WHERE table_name = 'ALOCACAO_MOTO';
  IF t > 0 THEN
    SELECT COUNT(*) INTO n FROM user_indexes WHERE index_name = 'IDX_ALOCACAO_MOTO';
    IF n = 0 THEN EXECUTE IMMEDIATE 'CREATE INDEX IDX_ALOCACAO_MOTO ON ALOCACAO_MOTO (MOTO_ID)'; END IF;
  END IF;
END;
/

DECLARE n NUMBER; t NUMBER; BEGIN
  SELECT COUNT(*) INTO t FROM user_tables WHERE table_name = 'ALOCACAO_MOTO';
  IF t > 0 THEN
    SELECT COUNT(*) INTO n FROM user_indexes WHERE index_name = 'IDX_ALOCACAO_VAGA';
    IF n = 0 THEN EXECUTE IMMEDIATE 'CREATE INDEX IDX_ALOCACAO_VAGA ON ALOCACAO_MOTO (VAGA_ID)'; END IF;
  END IF;
END;
/

