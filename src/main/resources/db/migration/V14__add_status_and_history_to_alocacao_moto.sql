-- V14: Adicionar campos de status e histórico para controle completo de alocações


ALTER TABLE ALOCACAO_MOTO ADD (
    DATA_HORA_FINALIZACAO TIMESTAMP,
    STATUS VARCHAR2(20) DEFAULT 'ATIVA' NOT NULL,
    MOTIVO_FINALIZACAO VARCHAR2(500),
    USUARIO_FINALIZACAO_ID NUMBER(19)
);

ALTER TABLE ALOCACAO_MOTO
ADD CONSTRAINT FK_ALOCACAO_MOTO_USUARIO_FINALIZACAO 
FOREIGN KEY (USUARIO_FINALIZACAO_ID) REFERENCES USUARIO(ID);

CREATE INDEX IDX_ALOCACAO_MOTO_STATUS ON ALOCACAO_MOTO(STATUS);
CREATE INDEX IDX_ALOCACAO_MOTO_DATA_ALOCACAO ON ALOCACAO_MOTO(DATA_HORA_ALOCACAO);
CREATE INDEX IDX_ALOCACAO_MOTO_DATA_FINALIZACAO ON ALOCACAO_MOTO(DATA_HORA_FINALIZACAO);
CREATE INDEX IDX_ALOCACAO_MOTO_MOTO_STATUS ON ALOCACAO_MOTO(MOTO_ID, STATUS);

UPDATE ALOCACAO_MOTO SET STATUS = 'ATIVA' WHERE STATUS IS NULL;

COMMENT ON COLUMN ALOCACAO_MOTO.STATUS IS 'Status da alocação: ATIVA, REALOCADA, FINALIZADA, CANCELADA';
COMMENT ON COLUMN ALOCACAO_MOTO.DATA_HORA_FINALIZACAO IS 'Data e hora quando a alocação foi finalizada';
COMMENT ON COLUMN ALOCACAO_MOTO.MOTIVO_FINALIZACAO IS 'Motivo da finalização da alocação';
COMMENT ON COLUMN ALOCACAO_MOTO.USUARIO_FINALIZACAO_ID IS 'Usuário responsável pela finalização da alocação';
