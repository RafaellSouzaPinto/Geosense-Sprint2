-- V11: Reset completo - Drop e recria todas as tabelas com as melhorias

-- Drop todas as tabelas na ordem correta (por causa das foreign keys)
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ALOCACAO_MOTO CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE DEFEITO CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE MOTO CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE VAGA CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE PATIO CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE USUARIO CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- Recriar USUARIO
CREATE TABLE USUARIO (
  ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NOME VARCHAR2(100) NOT NULL,
  EMAIL VARCHAR2(255) NOT NULL UNIQUE,
  SENHA VARCHAR2(255) NOT NULL,
  TIPO VARCHAR2(20) NOT NULL
);

-- Recriar PATIO com os novos campos
CREATE TABLE PATIO (
  ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  LOCALIZACAO VARCHAR2(255) NOT NULL,
  LOCAL VARCHAR2(255),
  NOME_UNIDADE VARCHAR2(255) NOT NULL,
  CAPACIDADE NUMBER(10)
);

-- Recriar VAGA
CREATE TABLE VAGA (
  ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  NUMERO NUMBER(10) NOT NULL,
  STATUS VARCHAR2(20) DEFAULT 'DISPONIVEL',
  TIPO VARCHAR2(30),
  PATIO_ID NUMBER(19) NOT NULL,
  CONSTRAINT FK_VAGA_PATIO FOREIGN KEY (PATIO_ID) REFERENCES PATIO(ID)
);

-- Recriar MOTO com PROBLEMA_IDENTIFICADO nullable
CREATE TABLE MOTO (
  ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  MODELO VARCHAR2(50) NOT NULL,
  PLACA VARCHAR2(10) UNIQUE,
  CHASSI VARCHAR2(50) UNIQUE,
  PROBLEMA_IDENTIFICADO VARCHAR2(255),
  VAGA_ID NUMBER(19),
  CONSTRAINT FK_MOTO_VAGA FOREIGN KEY (VAGA_ID) REFERENCES VAGA(ID)
);

-- Recriar DEFEITO
CREATE TABLE DEFEITO (
  ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  TIPOS_DEFEITOS VARCHAR2(40) NOT NULL,
  DESCRICAO VARCHAR2(255) NOT NULL,
  MOTO_ID NUMBER(19) NOT NULL,
  CONSTRAINT FK_DEFEITO_MOTO FOREIGN KEY (MOTO_ID) REFERENCES MOTO(ID)
);

-- Recriar ALOCACAO_MOTO
CREATE TABLE ALOCACAO_MOTO (
  ID NUMBER(19) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  MOTO_ID NUMBER(19) NOT NULL,
  VAGA_ID NUMBER(19) NOT NULL,
  MECANICO_RESPONSAVEL_ID NUMBER(19),
  DATA_HORA_ALOCACAO TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT FK_ALOCACAO_MOTO FOREIGN KEY (MOTO_ID) REFERENCES MOTO(ID),
  CONSTRAINT FK_ALOCACAO_VAGA FOREIGN KEY (VAGA_ID) REFERENCES VAGA(ID),
  CONSTRAINT FK_ALOCACAO_MECANICO FOREIGN KEY (MECANICO_RESPONSAVEL_ID) REFERENCES USUARIO(ID)
);

-- Inserir dados de exemplo
INSERT INTO USUARIO (NOME, EMAIL, SENHA, TIPO) VALUES ('Admin', 'admin@geosense.com', '$2a$10$D4CqT4GWL.NBIlrOxNwLIOY3X1xPTVLR5bKCkPjGtQjV1b.QsWyTu', 'ADMINISTRADOR');
INSERT INTO USUARIO (NOME, EMAIL, SENHA, TIPO) VALUES ('Mecânico João', 'joao@geosense.com', '$2a$10$D4CqT4GWL.NBIlrOxNwLIOY3X1xPTVLR5bKCkPjGtQjV1b.QsWyTu', 'MECANICO');

-- Inserir pátios de exemplo
INSERT INTO PATIO (LOCALIZACAO, LOCAL, NOME_UNIDADE, CAPACIDADE) VALUES ('Rua das Flores, 123', 'Setor A', 'Unidade Centro', 20);
INSERT INTO PATIO (LOCALIZACAO, LOCAL, NOME_UNIDADE, CAPACIDADE) VALUES ('Av. Principal, 456', 'Galpão 2', 'Unidade Norte', 15);

-- Inserir vagas automaticamente para os pátios
DECLARE
  v_patio_id NUMBER;
  v_capacidade NUMBER;
BEGIN
  -- Vagas para Pátio 1
  SELECT ID, CAPACIDADE INTO v_patio_id, v_capacidade FROM PATIO WHERE NOME_UNIDADE = 'Unidade Centro';
  FOR i IN 1..v_capacidade LOOP
    INSERT INTO VAGA (NUMERO, STATUS, PATIO_ID) VALUES (i, 'DISPONIVEL', v_patio_id);
  END LOOP;
  
  -- Vagas para Pátio 2
  SELECT ID, CAPACIDADE INTO v_patio_id, v_capacidade FROM PATIO WHERE NOME_UNIDADE = 'Unidade Norte';
  FOR i IN 1..v_capacidade LOOP
    INSERT INTO VAGA (NUMERO, STATUS, PATIO_ID) VALUES (i, 'DISPONIVEL', v_patio_id);
  END LOOP;
END;
/

-- Inserir algumas motos de exemplo
INSERT INTO MOTO (MODELO, PLACA, CHASSI, PROBLEMA_IDENTIFICADO) VALUES ('Honda CG 160', 'ABC-1234', null, 'reparos simples');
INSERT INTO MOTO (MODELO, PLACA, CHASSI, PROBLEMA_IDENTIFICADO) VALUES ('Yamaha Factor 125', 'DEF-5678', null, null);
INSERT INTO MOTO (MODELO, PLACA, CHASSI, PROBLEMA_IDENTIFICADO) VALUES ('Honda Biz 110', null, '9BD12345678901234', 'motor defeituoso');
